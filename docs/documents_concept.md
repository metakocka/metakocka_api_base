
# 1. Concept

Basic building blocks of MK are product, partner, pricelist and documents. With them, we can describe event in company bussiness timeline. Customer can get an 'offer', we issue a 'bill' or we purchase amount with 'acceptance form'. All this are documents. 

## 1.1 Call types
We support the following REST calls on all supported documents :
* /put\_document
* /update\_document
* /delete\_document
* /get\_document
* /get\_change\_documents - return list of documents that change after last call.

Not all calls are (yet) supported for every document type. We add support base on custumer needs.
Prefix for all methods is https://main.metakocka.si/rest/eshop/v1/ (example: https://main.metakocka.si/rest/eshop/v1/put_document)

Currenty we support :

Document type                | Put | Update | Delete | Get | GetChangeDocument| Local translation [SLO]|
-----------------------------|-----|--------|--------|-----|------------------|------------------|
warehouse\_delivery\_note    |X    |X       |        |X    | X                |Nalog za odpremo|
warehouse\_packing\_list     |X    |X       |        |X    | X                |Dobavnica|
warehouse\_receiving\_note   |X    |X       |        |X    | X                |Nalog za prejem|
warehouse\_acceptance\_note  |X    |X       |        |X    | X                |Prevzemnica|
sales\_order                 |X    |X       |        |X    |                  |Prodajno naročilo|
sales\_offer                 |X    |X       |        |X    |                  |Ponudba|
sales\_bill\_domestic        |X    |X       |        |X    |                  |Prodaja Račun Domači|
sales\_bill\_foreign         |X    |X       |        |X    |                  |Prodaja Račun Tuji|
sales\_bill\_retail          |X    |X       |        |X    |                  |Prodaja Račun maloprodajni|
purchase\_order              |X    |X       |        |X    |                  |Naročilnica|
purchase\_bill\_domestic     |X    |X       |        |X    |                  |Nabava Račun - domači|
purchase\_bill\_foreign      |X    |X       |        |X    |                  |Nabava Račun - tuji|
workorder                    |X    |        |        |X    |                  |Delovni nalog|

## 1.2. Building blocks
All calls have very simmilar JSON structure. Let's describe the most importand parts.

### 1.2.1 Document Head
Document head includes authentication parameters, type of send document and some basic document paramethers.

**Example** (Warning : this is only part of required call structure):
```javascript
{
    "secret_key":"seckey",
    "company_id":"16",
    "doc_type": "warehouse_delivery_note",
    "count_code": "dob10",
    "doc_date": "2014-05-20+02:00",
}
```

Notes :
* secret_key - secret value, get from MK.
* company_id - public value, get from MK.
* doc_type - document type. See [Call types](#call types)
* count_code - document number. It can be insert by REST call or automatically generated by MK. 
* doc_date - Document date.

### 1.2.2 Partner

**Example** (Warning : this is only part of required call structure):
```javascript
{
   "partner":{
      "business_entity":"true",
      "taxpayer":"true",
      "foreign_county":"false",
      "tax_id_number":"SI10040073",
      "customer":"eshop 1",
      "street":"Slovenska cesta 100",
      "post_number":"1000",
      "place":"Ljubljana",
      "country":"Slovenia",
      "partner_contact": {
         "name": "Rok Doltar",
         "phone": "05 320 24 88",
         "fax": "05 320 24 84",
         "gsm": "071 333 444",
         "email": "test@test.co.uk"
       }
   }
}
```
Notes :
* partner_contact - not required parameter

### 1.2.3 Product list

**Example** (Warning : this is only part of required call structure):
```javascript
"product_list":[
      {
         "count_code":"2",
         "amount":"10",
         "price":"11",
         "discount":"12",
         "tax":"085"         
      },
      {
         "code":"eshop_artikel_1",
         "amount":"20",
         "price":"21",
         "discount":"22;23",
         "tax":"200"         
      },
      {
         "count_code":"eshop_artikel_2",
         "code":"eshop_artikel_2",
         "name":"eshop_artikel_2",
         "name_desc":"eshop_artikel_2 opis",
         "doc_desc":"product desc on document",         
         "unit":"kom",
         "service":"false",
         "sales":"true",
         "purchasing":"false",
         "amount":"30",
         "price":"31",
         "discount":"32",
         "tax":"000"
      },
      {
         "code":"eshop_artikel_1",
         "amount":"20",
         "price_with_tax":"30",
         "discount":"22;23",
         "tax":"200"         
      }
   ]   
```

### 1.2.4 Respond
**Example**:
```javascript
{
    "opr_code": "0",
    "opr_time_ms": "441",
    "mk_id": "1600129491",
    "count_code": "dob4"
}
```

Notes :
* opr_code - status code of operation. '0' is OK, other values are error.
* mk_id - put_document call will return new insert document id.
* count_code - put_document call will return new insert document number.

**Error example 1**:
```javascript
{  
   "opr_code":"2",
   "opr_desc":"Unknown document type : warehouse_packing_list1",
   "opr_time_ms":"348"
}
```

**Error example 2**:
```javascript
{  
   "opr_code":"2",
   "opr_desc":"Paramether 'status_code' has invalid value : XXXactive. Valid values : active,finished,deleted",
   "opr_time_ms":"47"
}
```

## 1.3 get_document specific
### 1.3.1 Sum values
If one or more products on document have prices, sum for whole document is calculated. You can get the following sum value :
* sum\_basic
* sum\_discount
* sum\_tax\_085
* sum\_tax\_200
* sum\_tax\_ex1
* sum\_tax\_ex2
* sum\_tax\_ex3
* sum\_tax\_ex4
* sum\_prepayment
* sum\_all
* sum\_paid

## 1.4 update_document specific
Document update usually works together with get document :
* read document via "get\_document"
* change JSON values
* update document via "put\_document"

Update operations are request (=document) atomic - you always change the whole document values. We don't have REST call to change only specific fields on document.
Products on document are always mark as deleted and then new one are added base on product description in REST request. In case you have some specific fields on document products and this fields are not supported in REST interface, value of this fields will be deleted. 

If you perform get\_document and then put\_document, the following fields are different :
* put\_document : "company\_id" and "secret\_key" must be added
* put\_document : "mk\_id" must be added (otherwise new document will be inserted)
* put\_document : "count\_code" is ignored
* put\_document : for changing partner / receiver, first remove "mk\_id" and "count\_code" from partner. Otherwise old partner might be selected.
* get\_document : fields "sum\_*" are calculated values. For put\_documents we always calculate this values base on given product list. 

## Solution : how to put discount with value on order
For Example : we have webshop order with gross value 1x100 EUR and discount coupon 10 EUR. Base on document structure you can define document as follows :
1) Document_discount (not full request)
```javascript
{
   "discount_value" : "10",
   "product_list": [
        {
            "code": "product1",
            "amount": "1",
            "price_with_tax" : "100",
            "tax" : "EX4"
        }
    ],
	"notes" : "Included discount 10 EUR for coupon code MyCouponCode"
}
```

2) Negative product. You can add negative product to document, but is must be service. Not full request :
```javascript
{
    "product_list": [
        {
            "code": "product1",
            "amount": "1",
            "price_with_tax" : "100",
            "tax" : "EX4"
        },
        {
            "code": "MyCouponCode",
            "name" : "Coupon for 10 EUR"
            "amount": "-1",
            "price_with_tax" : "10",
            "tax" : "EX4",
            "unit" : "stor",
            "service" : "true",
            "sales" : "true"
        }		
    ],
}
```
